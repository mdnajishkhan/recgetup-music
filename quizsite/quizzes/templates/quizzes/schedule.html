{% extends 'quizzes/base.html' %}

{% block content %}
<div class="max-w-6xl mx-auto">
    
    <div class="flex items-center justify-between mb-8">
        <h2 class="text-3xl font-black text-white flex items-center gap-3">
            <span class="text-4xl">ðŸ“…</span> Class Schedule
        </h2>
    </div>

    <!-- Calendar / List View -->
    <div class="space-y-4">
        {% for class in classes %}
        <div class="group flex flex-col md:flex-row items-center justify-between p-6 bg-white/5 border border-white/10 rounded-2xl hover:bg-white/10 transition duration-300 relative overflow-hidden">
            <!-- Decorative Stripe -->
            <div class="absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-purple-500 to-amber-500 group-hover:w-2 transition-all"></div>

            <div class="flex items-center gap-6 w-full md:w-auto">
                <!-- Date Box -->
                <div class="flex-shrink-0 w-20 h-20 rounded-xl bg-gray-900 border border-white/10 flex flex-col items-center justify-center shadow-lg">
                    <span class="text-xs text-purple-400 font-bold uppercase tracking-wider">{{ class.start_time|date:"M" }}</span>
                    <span class="text-3xl font-black text-white">{{ class.start_time|date:"d" }}</span>
                    <span class="text-[10px] text-gray-500">{{ class.start_time|date:"D" }}</span>
                </div>

                <!-- Info -->
                <div class="text-left">
                    <h3 class="text-2xl font-bold text-white mb-1 group-hover:text-amber-400 transition">{{ class.title }}</h3>
                    <div class="flex flex-wrap items-center gap-4 text-sm text-gray-400">
                        <span class="flex items-center gap-1"><i class="fa-regular fa-clock"></i> {{ class.start_time|date:"g:i A" }} - {{ class.end_time|date:"g:i A" }}</span>
                        <span class="flex items-center gap-1"><i class="fa-solid fa-chalkboard-user"></i> {{ class.instructor }}</span>
                    </div>
                    {% if class.description %}
                    <p class="text-gray-500 text-sm mt-2 max-w-xl truncate">{{ class.description }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Action -->
            <div class="mt-6 md:mt-0 w-full md:w-auto flex flex-col items-stretch md:items-end gap-2">
                {% if class.meeting_link %}
                    <a href="{% url 'join_class' class.id %}" 
                       onclick="return checkClassTime(event, '{{ class.start_time|date:'c' }}', '{{ class.title|escapejs }}')"
                       class="px-8 py-3 rounded-xl bg-purple-600 hover:bg-purple-500 text-white font-bold transition shadow-lg shadow-purple-900/40 flex items-center justify-center gap-2">
                        Join Class <i class="fa-solid fa-video"></i>
                    </a>
                {% else %}
                    <button disabled class="px-8 py-3 rounded-xl bg-white/5 text-gray-500 font-bold border border-white/5 cursor-not-allowed">
                        Link Pending
                    </button>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="text-center py-20 bg-white/5 rounded-3xl border border-white/10 border-dashed">
            <i class="fa-solid fa-calendar-days text-5xl text-gray-600 mb-4"></i>
            <h3 class="text-xl font-bold text-white mb-2">No Classes Scheduled</h3>
            <p class="text-gray-400">Check back later or contact your instructor.</p>
        </div>
        {% endfor %}
    </div>

</div>

<!-- ðŸ”’ Countdown Modal (Reused from Home) -->
<div id="countdownModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
    <div class="bg-gray-900 border border-white/10 rounded-2xl p-8 w-full max-w-md text-center shadow-2xl transform scale-95 transition-transform duration-300 relative" id="countdownModalContent">
        
        <button onclick="closeCountdownModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white">
            <i class="fa-solid fa-xmark text-xl"></i>
        </button>

        <div class="w-16 h-16 rounded-full bg-red-500/10 flex items-center justify-center mx-auto mb-6">
            <i class="fa-solid fa-lock text-3xl text-red-500"></i>
        </div>
        
        <h3 class="text-2xl font-black text-white mb-2">Class Not Started</h3>
        <p class="text-gray-400 mb-6 text-sm">
            <span id="modalClassTitle" class="font-bold text-white"></span> starts in:
        </p>

        <div class="grid grid-cols-4 gap-2 mb-8">
            <div class="p-2 bg-white/5 rounded-lg border border-white/5">
                <div id="mDays" class="text-xl font-bold text-white">0</div>
                <div class="text-[10px] text-gray-500 uppercase">Days</div>
            </div>
            <div class="p-2 bg-white/5 rounded-lg border border-white/5">
                <div id="mHours" class="text-xl font-bold text-white">0</div>
                <div class="text-[10px] text-gray-500 uppercase">Hrs</div>
            </div>
            <div class="p-2 bg-white/5 rounded-lg border border-white/5">
                <div id="mMins" class="text-xl font-bold text-white">0</div>
                <div class="text-[10px] text-gray-500 uppercase">Mins</div>
            </div>
            <div class="p-2 bg-white/5 rounded-lg border border-white/5">
                <div id="mSecs" class="text-xl font-bold text-amber-500">0</div>
                <div class="text-[10px] text-gray-500 uppercase">Secs</div>
            </div>
        </div>

        <button onclick="closeCountdownModal()" class="w-full py-3 rounded-xl bg-white text-black font-bold hover:bg-gray-200 transition">
            Okay, I'll Wait
        </button>
    </div>
</div>

<script>
    let countdownInterval;

    function checkClassTime(event, startIso, title) {
        const start = new Date(startIso).getTime();
        const now = new Date().getTime();
        const diff = start - now;

        // Allow joining if within 15 minutes (900000 ms)
        if (diff > 15 * 60 * 1000) {
            event.preventDefault();
            showCountdownModal(start, title);
            return false;
        }
        return true;
    }

    function showCountdownModal(targetTime, title) {
        const modal = document.getElementById('countdownModal');
        const content = document.getElementById('countdownModalContent');
        
        document.getElementById('modalClassTitle').innerText = title;
        modal.classList.remove('hidden');
        
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            content.classList.remove('scale-95');
            content.classList.add('scale-100');
        }, 10);

        if (countdownInterval) clearInterval(countdownInterval);
        
        countdownInterval = setInterval(() => {
            const now = new Date().getTime();
            const distance = targetTime - now;

            if (distance < 0) {
                clearInterval(countdownInterval);
                closeCountdownModal();
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            document.getElementById("mDays").innerText = days;
            document.getElementById("mHours").innerText = hours;
            document.getElementById("mMins").innerText = minutes;
            document.getElementById("mSecs").innerText = seconds;

        }, 1000);
    }

    function closeCountdownModal() {
        const modal = document.getElementById('countdownModal');
        const content = document.getElementById('countdownModalContent');
        
        modal.classList.add('opacity-0');
        content.classList.remove('scale-100');
        content.classList.add('scale-95');
        
        setTimeout(() => {
            modal.classList.add('hidden');
            if (countdownInterval) clearInterval(countdownInterval);
        }, 300);
    }
</script>
{% endblock %}
